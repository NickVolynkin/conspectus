# Аварии помогают учиться

<p align="right">
<a href = "https://ritfest.ru/"><img src = "https://pbs.twimg.com/profile_images/986564000828751877/j_1x0CAt.jpg" width="20px" height=20px"> РИТ 2019</a> 
</p>

**Алексей Кирпичников (СКБ Контур)**

[Слайды](https://github.com/lananovikova10/conspectus/blob/master/2_%D0%90%D0%B2%D0%B0%D1%80%D0%B8%D0%B8_%D0%BF%D0%BE%D0%BC%D0%BE%D0%B3%D0%B0%D1%8E%D1%82_%D1%83%D1%87%D0%B8%D1%82%D1%8C%D1%81%D1%8F_%D0%90%D0%BB%D0%B5%D0%BA%D1%81%D0%B5%D0%B8%CC%86.pdf)

- [Вступление](#Вступление)
- [Что такое факап](#Что_такое_факап)
- [Как получить пользу от факапа](#Как_получить_пользу_от_факапа)
- [Метод прогрессивного джипега](#Метод_прогрессивного_джипега)
- [Шаблон](#Шаблон)
- [Кто это будет читать](#Кто_это_будет_читать)
- [Как писать](#Как_писать)

## Вступление

* Я с самого прихода в компанию (5 лет) веду блокнот, где записываю, что можно улучшить в наших процессах в инфраструктурой команде. Что там есть? Мониторинг. Автодеплой. Постмортемы. 
* Если что-то произошло в продакшн, какой-то факап, давайте это опишем, разберем причины и ошибки и вместе изменим наши процессы разработки, тестирования, CI, чтобы таких инцидентов больше не было. 
* Из всех этих практик написание постмортемов оказалось самой сложной для внедрения инженерной практикой. Инженеры не очень любят писать отчеты, но в этой практике очень много полезного. 

## Что такое факап
 
* Что такое факап? Блог платформа потеряла все записи одного пользователя из миллиона. Сервис для офисных работников, сервис два часа подряд ночью с субботы на воскресенье не работал. У вас есть Grafana, она не работала 15 минут, ничего не сломалось, но графики не было видно. 
* По версии pagerduty, инцидент - любой незапланированный перерыв в работе сервиса, которые отразился на пользователях. 
* Пользователи заметили, потеряны любые данные, потребовалось вмешательство дежурного, решение заняло слишком много времени или не сработал мониторинг. 
* Добавлю от себя: заметили внешние или внутренние пользователи, повезло, а в следующий раз может не повезти, инцидент касается нескольких команд, хотя бы один инженер считает это факапом. 
* Разбор инцидента - это отличная площадка для сотрудничества многих команд, обмена опытом, общения. 

 ## Как получить пользу от факапа
 
 <a href="https://ibb.co/ZHqBJxb"><img src="https://i.ibb.co/ZHqBJxb/screenshot-www-youtube-com-2019-05-28-15-56-42.png" alt="screenshot-www-youtube-com-2019-05-28-15-56-42" border="0"></a>
 
* Вредные советы - искрит виноватых, закрывать доступ в прод, увольнять.
* Постмортем - не поиск виноватого! Доверие к сотрудникам. 
* **Инструкция от Джона Олспо**. Книга Blameless postmortems and adjust culture. 
* Спросите, какие события наблюдали
* Когда и какие действия предпринимали
* Какого результата ожидали
* Из каких предположений исходили
* Как понимаю последовательность событий
* Спрашивайте без угрозы наказания!
* Нам нужны правдивые ответы на вопросы. 
* Отчет об инциденте - это обратная связь. 
* Заставить инженеров поверить, что это нужно и важно. 

## Метод прогрессивного джипега 
Существует простой способ организации времени. Называется метод прогрессивного джипега. В любую секунду любой проект готов на 100%, хотя проработанность может быть и на 4%.

<a href="https://ibb.co/TrTgMFB"><img src="https://i.ibb.co/TrTgMFB/jpeg.jpg" alt="jpeg" border="0"></a>

В зависимости от имеющегося времени проект можно прорабатывать до пикселя, а можно оставить на стадии концептуальной зарисовки.

Не нужно пытаться сделать "полностью отрендеренную картинку", напишите отчет в общих чертах, восстановите хронологию событий (она забывается первой и ее сложно восстановить), не пишите связный литературный текст. 

Вот пример реального постмортема, как видно, тут написаны только общие наблюдения и метка времени. Потом по этому мы сможем восстановить последовательность событий и сделать выводы. Еще хорошо делать скриншоты.  

<a href="https://ibb.co/b3Rsc3Y"><img src="https://i.ibb.co/b3Rsc3Y/screenshot-www-youtube-com-2019-05-28-16-11-04.png" alt="screenshot-www-youtube-com-2019-05-28-16-11-04" border="0"></a>

## Шаблон

Наконец, после закрытия инцидента, нужно написать более развернутый отчет. Но Лень! И много задач! 
Хорошо, если есть шаблон постмортема, чтобы снять блок пустого листа. Почитайте гуру, в каждой из книг есть шаблоны инцидентов. 

Но я могу добавить от себя: 
* сделайте памятку с примерами, например, у нас есть раздел ущерб и в нем пункт Качественная оценка. Вот шаблон к этому разделу. 

<a href="https://ibb.co/crcWDKh"><img src="https://i.ibb.co/crcWDKh/screenshot-www-youtube-com-2019-05-28-16-27-06.png" alt="screenshot-www-youtube-com-2019-05-28-16-27-06" border="0"></a>

* Шаблон - это набор описаний того, что в этом месте/разделе ожидается. 
* Глоссарий - перечислите часто используемые термины с расшифровкой. Контекст мог поменяться. 

<a href="https://ibb.co/SQBRJDh"><img src="https://i.ibb.co/SQBRJDh/screenshot-www-youtube-com-2019-05-28-16-31-24.png" alt="screenshot-www-youtube-com-2019-05-28-16-31-24" border="0"></a>

* Если вы прикладываете материалы, артефакты, например, ссылки на метрики, на переписку, сделайте копии, скриншоты, данные могут перетереться, вы можете сменить корпоративный мессенджер и т.д.  

## Кто это будет читать

* В любом гуру-гайде написано, что по результатам каждого постмортема вы должны поставить action items - задачи в баг-трекере и проставить их ссылками в постмортеме. Обратная связь замкнулась. 

<a href="https://ibb.co/wWsMyxm"><img src="https://i.ibb.co/wWsMyxm/screenshot-www-youtube-com-2019-05-28-16-36-46.png" alt="screenshot-www-youtube-com-2019-05-28-16-36-46" border="0"></a>

* Раньше мы изучали этот инцидент изолированно, но он не один, есть статистика. У нас накопилось больше 1000 таких отчетов. Давайте анализировать!
* Мы проводим аналитику этих отчетов и находим какие-то общие паттерны и выводы.  

<a href="https://ibb.co/ckWbcJ5"><img src="https://i.ibb.co/ckWbcJ5/screenshot-www-youtube-com-2019-05-28-16-40-26.png" alt="screenshot-www-youtube-com-2019-05-28-16-40-26" border="0"></a>

<a href="https://ibb.co/zr1sYQW"><img src="https://i.ibb.co/zr1sYQW/screenshot-www-youtube-com-2019-05-28-16-43-03.png" alt="screenshot-www-youtube-com-2019-05-28-16-43-03" border="0"></a>

* Что мы анализируем: длительность, ущерб, триггеры (причины), возможные пути предотвращения, рекомендации.  
* Смысл аналитики - важно понять, куда нужно вкладывать усилия прямо сейчас: алерты, деплой, метрики, хостинг и т.д.
* Если много причин "Неизвестно", отчеты заполняются не слишком хорошо. 

<a href="https://ibb.co/FsCmRmV"><img src="https://i.ibb.co/FsCmRmV/screenshot-www-youtube-com-2019-05-28-16-44-47.png" alt="screenshot-www-youtube-com-2019-05-28-16-44-47" border="0"></a>

## Как писать

* Ведите постмортемы в том же багтрекере, где разработка
* Сделайте фиксированные поля, потом проще делать аналитику
* Google ведут в гуглдоке
* Можно связать задачу с постмортемом
* Пример заполненного инцидента

<a href="https://ibb.co/tpTqXfV"><img src="https://i.ibb.co/tpTqXfV/screenshot-www-youtube-com-2019-05-28-16-48-05.png" alt="screenshot-www-youtube-com-2019-05-28-16-48-05" border="0"></a>

* Постройте команду инженеров, которых волнует качество сервисов
* Наша команда называется Q-team, они не занимаются аналитикой на фултайм, но иногда пишут развернутые отчеты и рекоментации. 

## Полезные ссылки

* https://www.kitchensoap.com/2013/09/30/learning-from-failure-at-etsy/ 
* https://www.pagerduty.com/resources/learn/post-mortem-incident-report/ 
* https://landing.google.com/sre/sre-book/chapters/postmortem-culture/ 

**Совет**: Когда придете на работу завтра с утра - начните это делать. 
Заведите проект для факапов, возьмите чужой шаблон, когда что-то взорвется - начните это описывать. 

## Вопросы

* **Как скоро вы приучили инженеров писать постмортемы?** А-то мы попробовали и у нас все стухло. Как мотивировать. Нельзя заставить, хоть кто-то начал хоть что-то писать 2-3 года назад, до сих пор это не делают 100 процентов разработчиков, как сделать 100 процентов - я не знаю. Объясняйте, рассказывайте, демонстрируйте важность, в том числе в виде аналитики и реальных улучшений. 
* **Сколько метрик в день собираете, какие СУБД для графиков?** Порядка 10-100 миллионов уникальных метрик в системе, стек Graphite, хранилище Clickhouse, разрешение 1 минута. 
* **Вы создаете инциденты по метрикам в автоматическом режиме или только вручную?** Нет, я не верю в это, это плохая практика, замусорирование багтрекера не заполеннными инцидентами, там будет много ложных, дублирующих артефактов. Мне бы не хотелось захламлять **хранилище знаний**. Ценность именно в анализе. 
* **Считаете ли вы факапом превышение SLA?** Зависит от продукта, если это прописано в условиях продукта, требования нарушены. Инцидент рождается, если инженер считает его таковым. Но чаще всего команда предъявляет к себе требования жестче, чем SLA. 
* **Оцениваете ли вы материальные убытки?** Где возможно - да. Но не возводим в культ. 
* Пункт: некогда писать, война, очень точный. **Как ваши инженеры, когда критичный даунтайм, бизнес теряет деньги, как натаскивать их писать?** Бывают ситуации, когда важнее чинить, чем писать хронологию, не всегда стоит писать, но я пытаюст предложить компромисс. Не обязательно вкладывать 100 процентов усилий прямо сейчас, делайте скриншоты, пометки на бумаге, что угодно. Это обязательный минимум. Но приоритет всегда у "пожара". 
* **Есть ли ночные дежурные? Есть ли у них регламенты?** Есть. У каждой команды своя практика дежурства. Мы не диктуем график.  
* ****





